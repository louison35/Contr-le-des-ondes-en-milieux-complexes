import matplotlib.pyplot as plt
import numpy as np
import random as rd

n = 1
a = 0.1
aa = 100
b = 0.4
bb = 400
c0 = 3 * 10**8

def mode(f1):
    omega = 2*np.pi*f1
    Ni = 1
    fi = 0
    A = True

    while A:
        fi = (c0 * Ni) / (2 * a)
        if fi > f1:
            A = False
        else:
            A = True
            Ni += 1

    N = Ni - 1
    k = [np.sqrt((omega / c0) ** 2 - ((i+1) * (np.pi / a)) ** 2) for i in range(N)]
    
    return k,N


def green_in(x1, y1, k1, N):
    g1 = np.zeros((N, len(x1)), dtype=complex)
    g2 = np.zeros((N, len(x1)), dtype=complex)

    for i in range(N):
        for j in range(len(x1)):
            g1[i, j] = (
                np.sqrt(2 / a)
                * ((-1) ** i)
                * (1 / np.sqrt(k1[i]))
                * np.sin(((i+1)*(np.pi/a))* y1[j])
                * np.exp(1j * k1[i] * x1[j])
            )

            g2[i, j] = (
                np.sqrt(2 / a)
                * ((-1) ** i)
                * (1 / np.sqrt(k1[i]))
                * np.sin(((i+1)*(np.pi/a)) * y1[j])
                * np.exp(1j * k1[i] * abs(b - x1[j]))
            )

    return np.concatenate((g1, g2))


def green_dd(x1, y1, k1, N):
    gi = np.zeros((len(x1), len(x1)), dtype=complex)
    g = np.zeros((len(x1), len(x1)), dtype=complex)
    for o in range(N):
        for i in range(len(x1)):
            for j in range(len(x1)):
                gi[i, j] = (
                    -np.sin(((o+1)*(np.pi/a)) * y1[i])
                    * np.sin(((o+1)*(np.pi/a)) * y1[j])
                    * (2 *(1/a) *( 1/k1[o]))
                    * np.exp(1j * k1[o] * abs(x1[j] - x1[i]))
                )
        g = g + gi
    return g


def S_matrix(x1, y1, k1, alpha, N):
    G1 = green_in(x1, y1, k1, N)
    G_t1 = np.transpose(G1)
    G_dd1 = green_dd(x1, y1, k1, N)
    w1 = alpha - G_dd1
    w_inv1 = np.linalg.inv(w1)
    S1 = np.dot(G1, np.dot(w_inv1, G_t1))
    S0 = np.zeros((2 * N, 2 * N), dtype=complex)
    G0 = [np.exp(1j * b * k1[o]) for o in range(N)]
    t0 = np.diag(G0)
    S0[:N, N : 2 * N] = t0
    S0[N : 2 * N, :N] = t0
    return S1-S0


def M_alpha(a_tot):
    alphai = np.zeros((len(a_tot), len(a_tot)), dtype=complex)
    for i in range(len(a_tot)):
        alphai[i, i] = 1 / -(a_tot[i] * 1j)
    result = alphai
    return result

def coef_np(M, N):
    M = abs(M)
    t = M[N:,:N]
    t = np.dot(t,np.conj(np.transpose(t)))
    r = M[:N,:N]
    r = np.dot(r,np.conj(np.transpose(r)))
    t_moy = 0
    r_moy = 0
    for i in range(N):
        t_moy += t[i,i]
        r_moy += r[i,i]
    return (t_moy/N),(r_moy/N)



x =  [0.018181818181818184, 0.018181818181818184, 0.018181818181818184, 0.018181818181818184, 0.018181818181818184, 0.018181818181818184, 0.018181818181818184, 0.018181818181818184, 0.018181818181818184, 0.018181818181818184, 0.03636363636363637, 0.03636363636363637, 0.03636363636363637, 0.03636363636363637, 0.03636363636363637, 0.03636363636363637, 0.03636363636363637, 0.03636363636363637, 0.03636363636363637, 0.03636363636363637, 0.05454545454545455, 0.05454545454545455, 0.05454545454545455, 0.05454545454545455, 0.05454545454545455, 0.05454545454545455, 0.05454545454545455, 0.05454545454545455, 0.05454545454545455, 0.05454545454545455, 0.07272727272727274, 0.07272727272727274, 0.07272727272727274, 0.07272727272727274, 0.07272727272727274, 0.07272727272727274, 0.07272727272727274, 0.07272727272727274, 0.07272727272727274, 0.07272727272727274, 0.09090909090909091, 0.09090909090909091, 0.09090909090909091, 0.09090909090909091, 0.09090909090909091, 0.09090909090909091, 0.09090909090909091, 0.09090909090909091, 0.09090909090909091, 0.09090909090909091, 0.1090909090909091, 0.1090909090909091, 0.1090909090909091, 0.1090909090909091, 0.1090909090909091, 0.1090909090909091, 0.1090909090909091, 0.1090909090909091, 0.1090909090909091, 0.1090909090909091, 0.12727272727272726, 0.12727272727272726, 0.12727272727272726, 0.12727272727272726, 0.12727272727272726, 0.12727272727272726, 0.12727272727272726, 0.12727272727272726, 0.12727272727272726, 0.12727272727272726, 0.14545454545454548, 0.14545454545454548, 0.14545454545454548, 0.14545454545454548, 0.14545454545454548, 0.14545454545454548, 0.14545454545454548, 0.14545454545454548, 0.14545454545454548, 0.14545454545454548, 0.16363636363636364, 0.16363636363636364, 0.16363636363636364, 0.16363636363636364, 0.16363636363636364, 0.16363636363636364, 0.16363636363636364, 0.16363636363636364, 0.16363636363636364, 0.16363636363636364, 0.18181818181818182, 0.18181818181818182, 0.18181818181818182, 0.18181818181818182, 0.18181818181818182, 0.18181818181818182, 0.18181818181818182, 0.18181818181818182, 0.18181818181818182, 0.18181818181818182, 0.293, 0.336, 0.34]
y =  [0.009090909090909092, 0.018181818181818184, 0.027272727272727275, 0.03636363636363637, 0.045454545454545456, 0.05454545454545455, 0.06363636363636363, 0.07272727272727274, 0.08181818181818182, 0.09090909090909091, 0.009090909090909092, 0.018181818181818184, 0.027272727272727275, 0.03636363636363637, 0.045454545454545456, 0.05454545454545455, 0.06363636363636363, 0.07272727272727274, 0.08181818181818182, 0.09090909090909091, 0.009090909090909092, 0.018181818181818184, 0.027272727272727275, 0.03636363636363637, 0.045454545454545456, 0.05454545454545455, 0.06363636363636363, 0.07272727272727274, 0.08181818181818182, 0.09090909090909091, 0.009090909090909092, 0.018181818181818184, 0.027272727272727275, 0.03636363636363637, 0.045454545454545456, 0.05454545454545455, 0.06363636363636363, 0.07272727272727274, 0.08181818181818182, 0.09090909090909091, 0.009090909090909092, 0.018181818181818184, 0.027272727272727275, 0.03636363636363637, 0.045454545454545456, 0.05454545454545455, 0.06363636363636363, 0.07272727272727274, 0.08181818181818182, 0.09090909090909091, 0.009090909090909092, 0.018181818181818184, 0.027272727272727275, 0.03636363636363637, 0.045454545454545456, 0.05454545454545455, 0.06363636363636363, 0.07272727272727274, 0.08181818181818182, 0.09090909090909091, 0.009090909090909092, 0.018181818181818184, 0.027272727272727275, 0.03636363636363637, 0.045454545454545456, 0.05454545454545455, 0.06363636363636363, 0.07272727272727274, 0.08181818181818182, 0.09090909090909091, 0.009090909090909092, 0.018181818181818184, 0.027272727272727275, 0.03636363636363637, 0.045454545454545456, 0.05454545454545455, 0.06363636363636363, 0.07272727272727274, 0.08181818181818182, 0.09090909090909091, 0.009090909090909092, 0.018181818181818184, 0.027272727272727275, 0.03636363636363637, 0.045454545454545456, 0.05454545454545455, 0.06363636363636363, 0.07272727272727274, 0.08181818181818182, 0.09090909090909091, 0.009090909090909092, 0.018181818181818184, 0.027272727272727275, 0.03636363636363637, 0.045454545454545456, 0.05454545454545455, 0.06363636363636363, 0.07272727272727274, 0.08181818181818182, 0.09090909090909091, 0.044, 0.054, 0.002]
params = [9.999999974752427e-07, 0.6457780599594116, 3.0746634006500244, 9.999999974752427e-07, 0.24305593967437744, 0.9503501653671265, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 2.531497001647949, 9.999999974752427e-07, 9.999999974752427e-07, 2.5169827938079834, 9.999999974752427e-07, 0.021427897736430168, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 0.5249437689781189, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 5.265955924987793, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 1.6932401657104492, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 0.2745633125305176, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 1.8153400421142578, 9.999999974752427e-07, 0.3444792330265045, 0.4218091368675232, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 0.3139100670814514, 9.999999974752427e-07, 9.999999974752427e-07, 0.9563164710998535, 9.999999974752427e-07, 0.2618236541748047, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 0.2693589925765991, 0.2536666691303253, 9.999999974752427e-07, 9.999999974752427e-07, 1.1421725749969482, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 0.09048323333263397, 0.03638637810945511, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 2.8567092418670654, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 0.16506879031658173, 9.999999974752427e-07, 0.7802820205688477, 0.6522682309150696, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 0.7884305715560913, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 0.0504661500453949, 4.251327037811279, 9.999999974752427e-07, 1.4605472087860107, 0.2520137429237366, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, 9.999999974752427e-07, -6.0, -6.0, -6.0]

alpha = M_alpha(params)

x0 = [i for i in x[-3:]]
y0 = [i for i in y[-3:]]
par0 = [i for i in params[-3:]]
alpha0 = M_alpha(par0)

def test(f):
    ft = np.linspace(f-0.5,f+0.49,800)
    t = []
    t0 = []
    for i in ft:
        fi = i*10**9
        k,N = mode(fi)
        Si = S_matrix(x, y, k, alpha, N)
        S0i = S_matrix(x0, y0, k, alpha0, N)
        ti = coef_np(Si, N)[0]
        t0i = coef_np(S0i, N)[0]
        t.append(ti)
        t0.append(t0i)
    return ft,t,t0

f,t,t0= test(7)

plt.rcParams['figure.dpi'] = 300
plt.plot(f,t,"-",label = "Optimisé")
plt.plot(f,t0,"-",label = "Non optimisé")
plt.xlabel("Fréquence du signal (GHz)")
plt.ylabel("Transmission <T>")
plt.ylim((0.0,1))
plt.grid()
plt.legend()
plt.show()




    
